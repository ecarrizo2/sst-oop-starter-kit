name: Dependabot Auto-Approve and Handle Merge for Minor Bumps

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

jobs:
  auto-approve-and-merge-queue:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Check Dependabot PR and Approve
        env:
          GITHUB_TOKEN: ${{ secrets.TKWW_GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          echo "Processing PR #$PR_NUMBER: $PR_TITLE by $PR_AUTHOR"

          if [[ "$PR_AUTHOR" != "dependabot[bot]" ]]; then
            echo "Not a Dependabot PR. Skipping..."
            exit 0
          fi

          # Use more precise regex to extract version information
          OLD_VERSION=$(echo "$PR_TITLE" | grep -oP 'from \K\d+\.\d+\.\d+')
          NEW_VERSION=$(echo "$PR_TITLE" | grep -oP 'to \K\d+\.\d+\.\d+')

          # Check for major version change
          if [[ ${OLD_VERSION%%.*} != ${NEW_VERSION%%.*} ]]; then
            echo "Major version change detected. Skipping auto-merge..."
            exit 0
          fi

          # Blacklist check
          BLACKLIST="newrelic"
          if echo "$PR_TITLE" | grep -qE "$(echo $BLACKLIST | sed 's/,/|/g')"; then
            echo "Library is in the blacklist. Skipping auto-merge..."
            exit 0
          fi

          # Auto approve the PR
          echo "Approving PR #$PR_NUMBER..."
          gh pr review $PR_NUMBER --approve --body "Auto-approved by workflow for Dependabot PRs."

          # Auto merge the PR
          echo "Merging PR #$PR_NUMBER..."
          gh pr merge $PR_NUMBER --squash --auto || {
            echo "Merge failed. Please review manually."
            exit 1
          }
